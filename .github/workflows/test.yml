name: test

on: [push]

jobs:
  test:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: leafo/gh-actions-lua@v10
      - uses: leafo/gh-actions-luarocks@v4
      - name: install luacheck
        run: luarocks install luacheck
      - name: lint
        run: luacheck home
      - name: deps
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: stow libglib2.0-dev libmpv-dev dbus-x11 dconf-cli libavformat-dev
          # libglib2.0-dev libmpv-dev libavformat-dev - mpv-mpris
          # dbus-x11 dconf-cli - ibus
          version: 1.0
      - name: yq # needed for the mason registry to work locally (https://github.com/williamboman/mason.nvim/pull/1457)
        uses: mikefarah/yq@master
      - name: neovim
        uses: rhysd/action-setup-vim@v1
        with:
          # apt neovim is too old
          neovim: true
          version: nightly # using vim.fs.joinpath
      - name: deps - llvm # ccls dep
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: 12.0
      - name: deps - node.js # various dependencies
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
      - name: debug
        run: |
          pipx environement --help
          # stow conflicts
          rm ~/.bashrc ~/.bash_profile
          make home
          make tree-sitter-cli
      - name: build
        run: make
      - name: install
        run: |
          export $(dbus-launch) # dconf required dbus
          # stow conflicts
          rm ~/.bashrc ~/.bash_profile
          make install
      - name: test neovim
        # make sure neovim doesn't output errors
        run: |
          [[ -z "$(nvim --headless +qa 2>&1)" ]] || exit 1
