#!/bin/sh

DIR=$( cd "$(dirname "$0")" ; pwd -P )
LOCAL_SHARE_DIR=~/.local/share
LOCAL_BIN_DIR=~/.local/bin
LOCAL_CONFIG_DIR=~/.config

# change to the dotfiles directory
echo -n "Changing to the $DIR directory ..."
cd $DIR

for f in $DIR/home/*; do
  b=$(basename $f)
  echo "Installing .$b"
  ln -sf ~/dotfiles/home/$b ~/.$b
done

# move executable files to bin
echo "Moving executable files into $LOCAL_BIN_DIR directory"
mkdir -p $LOCAL_BIN_DIR
ln -sf $DIR/bin/* $LOCAL_BIN_DIR

# install config files
echo "Moving config files into $LOCAL_CONFIG_DIR directory"
mkdir -p $LOCAL_CONFIG_DIR
ln -sf $DIR/config/* $LOCAL_CONFIG_DIR

#install fonts
mkdir -p $LOCAL_SHARE_DIR
ln -sf $DIR/share/* $LOCAL_SHARE_DIR
fc-cache -f

mkdir -p ~/.urxvt/ext
ln -sf $DIR/urxvt/urxvt-resize-font/resize-font ~/.urxvt/ext
ln -sf $DIR/urxvt/urxvt-perls/keyboard-select ~/.urxvt/ext
ln -sf $DIR/urxvt/urxvt-perls/deprecated/url-select ~/.urxvt/ext

mkdir -p ~/.gnupg
ln -sf $DIR/gpg-agent.conf ~/.gnupg

mkdir -p ~/.anthy
ln -sf $DIR/private_words_default ~/.anthy

# sbt configuration
SBT_CONFIG_DIR=~/.sbt/1.0
mkdir -p $SBT_CONFIG_DIR
ln -sf $DIR/sbt/global.sbt $SBT_CONFIG_DIR

ln -sf /bin/dash $LOCAL_BIN_DIR/sh

echo "Initializing submodules..."
git submodule update --recursive --init

echo "Installing powerline"
pip install --user --editable=$DIR/powerline
ln -s $POWERLINE_DIR/powerline/scripts/powerline $LOCAL_BIN_DIR
ln -s $POWERLINE_DIR/powerline/scripts/powerline-daemon $LOCAL_BIN_DIR
ln -s $POWERLINE_DIR/powerline/scripts/powerline-lint $LOCAL_BIN_DIR
ln -s $POWERLINE_DIR/powerline/scripts/powerline-render $LOCAL_BIN_DIR
ln -s $POWERLINE_DIR/powerline/scripts/powerline-config $LOCAL_BIN_DIR
ln -s $POWERLINE_DIR/powerline/bindings/tmux/powerline.conf ~/.local/powerline.conf

# coc.nvim
echo "Installing coc extensions"
mkdir -p $LOCAL_CONFIG_DIR/coc/extensions
ln -sf $DIR/coc/extensions/package.json $LOCAL_CONFIG_DIR/coc/extensions
# TODO: add an upstream native command: vim -c 'CocInstall -sync|q'
( cd $LOCAL_CONFIG_DIR/coc/extensions && npm install )

echo "Installing fzf"
# vimrc does rtp+=~/.fzf https://github.com/junegunn/fzf/blob/master/README-VIM.md
# therefore it has to be installed in the home directory
FZF_DIR=$DIR/home/fzf
# install fzf
# Officially:
# $DIR/fzf/install --all
# Manually
$FZF_DIR/install --no-update-rc --no-completion --no-keybindings # download executable
# zsh bindings
ZSH_PLUGINS_DIR=~/.oh-my-zsh/custom/plugins
ZSH_THEMES_DIR=~/.oh-my-zsh/custom/themes
mkdir -p $ZSH_PLUGINS_DIR/fzf
ln -sf $FZF_DIR/shell/completion.zsh $ZSH_PLUGINS_DIR/fzf
ln -sf $FZF_DIR/shell/key-bindings.zsh $ZSH_PLUGINS_DIR/fzf

# Additional oh-my-zsh plugins
ln -sf $DIR/sandboxd $ZSH_PLUGINS_DIR
ln -sf $DIR/zsh-syntax-highlighting $ZSH_PLUGINS_DIR
ln -sf $DIR/powerlevel10k $ZSH_THEMES_DIR

# install xwinwrap
( cd xwinwrap && make )

# install mpv-mpris
( cd mpv-mpris && make )

( cd $DIR/gitflow && make prefix=$HOME/.local install )

# install ccls
( cd ccls && \
  cmake -H. -BRelease -DCMAKE_BUILD_TYPE=Release && \
  cmake --build Release )

# dconf dump /destop/ibus > ibus.dconf
dconf load /desktop/ibus/ < $DIR/ibus.dconf
# dconf dump /org/freedesktop/ibus/ > ibus-engine.dconf
dconf load /org/freedesktop/ibus/ < $DIR/ibus-engine.dconf # anthy should input hiragana by default
