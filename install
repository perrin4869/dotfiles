#!/bin/sh

DIR=$( cd "$(dirname "$0")" ; pwd -P )
LOCAL_CONFIG_DIR=${XDG_CONFIG_HOME:-$HOME/.config}
LOCAL_SHARE_DIR=${XDG_DATA_HOME:-$HOME/.local/share}
LOCAL_BIN_DIR=~/.local/bin

DEPS_DIR=$DIR/deps
DCONF_DIR=$DIR/dconf

# Make sure the expected directory structure is in place
# Prevent stow from symlink ~/.config -> ~/dotfiles/home/.config
# And instead bring in the contents
mkdir -p $LOCAL_CONFIG_DIR
mkdir -p $LOCAL_SHARE_DIR
mkdir -p $LOCAL_BIN_DIR

# change to the dotfiles directory
echo -n "Changing to the $DIR directory ..."
cd $DIR

stow -v home

# Refresh fonts
fc-cache -f

echo "Initializing submodules..."
git submodule update --recursive --init

echo "Installing powerline"
pip install --user --editable=$DEPS_DIR/powerline

# Used by vim-markdown-autopreview
echo "Installing grip"
pip install --user --editable=$DEPS_DIR/grip

echo "Installing fzf"
# install fzf
# Officially:
# $DEPS_DIR/fzf/install --all
# Manually
$DEPS_DIR/fzf/install --no-update-rc --no-completion --no-keybindings # download executable

# coc.nvim
echo "Installing coc extensions"
# TODO: add an upstream native command: vim -c 'CocInstall -sync|q'
( cd $LOCAL_CONFIG_DIR/coc/extensions && npm install )

# install xwinwrap
( cd $DEPS_DIR/xwinwrap && make )

# install mpv-mpris
( cd $DEPS_DIR/mpv-mpris && make )

# install gitflow
( cd $DEPS_DIR/gitflow && make prefix=$HOME/.local install )

# install ccls
( cd $DEPS_DIR/ccls && \
  cmake -H. -BRelease -DCMAKE_BUILD_TYPE=Release && \
  cmake --build Release )

# dconf dump /destop/ibus > ibus.dconf
dconf load /desktop/ibus/ < $DCONF_DIR/ibus.dconf
# dconf dump /org/freedesktop/ibus/ > ibus-engine.dconf
dconf load /org/freedesktop/ibus/ < $DCONF_DIR/ibus-engine.dconf # anthy should input hiragana by default
