#!/bin/bash

set -u

. "$HOME/.local/libexec/guards"

XDG_STATE_HOME=${XDG_STATE_HOME:-$HOME/.local/state}
LOG_DIR="$XDG_STATE_HOME/xsession"
LOG_FILE="$LOG_DIR/startup.log"

mkdir -p "$LOG_DIR"
exec > >(tee -a "$LOG_FILE") 2>&1

log() { printf '[%s] %s\n' "$(date +'%F %T')" "$*"; }
warn_missing() { log "missing: $*"; }
run_guarded() { have "$1" && "$@" || warn_missing "$1"; }
run_bg_guarded() { have "$1" && ( "$@" & ) || warn_missing "$1"; }

export TERMINAL="${TERMINAL:-terminal}"
export FILE="${FILE:-filemanager}"
export MENU="${MENU:-menu}"
export BROWSER="${BROWSER:-browser}"
export EDITOR="${EDITOR:-editor}"

if [[ -z ${IM+x} ]]; then
  if have fcitx5 || have fcitx; then
    IM=fcitx
  elif have ibus; then
    IM=ibus
  fi
fi

if [[ -n ${IM:-} ]]; then
  log "IM auto-detected as $IM"
  export IM

  # X Input Method (xim)
  export GTK_IM_MODULE=${IM/ibus/xim} # fix ibus integration with chromium/chrome (ibus xim emulation is broken?), keep fcitx
  export XMODIFIERS=@im=$IM
  export QT_IM_MODULE=$IM # qutebrowser does not support xim
  export GLFW_IM_MODULE=ibus # https://github.com/kovidgoyal/kitty/issues/469
else
  log "IM was not auto-detected, skipping IM setup"
fi

if [[ -z ${DBUS_SESSION_BUS_ADDRESS:-} ]]; then
  have dbus-launch && export $(dbus-launch --exit-with-x11) || warn_missing dbus-launch
else
  log "dbus session already existing $DBUS_SESSION_BUS_ADDRESS"
fi

# SOFTWARE_VSYNC is a user-local option specific to this repository 
# to toggle compositor vsync on environments where hardware vsync is 
# not available, if required, set it via .pam_environment or similar
[[ -v SOFTWARE_VSYNC ]] && PICOM_VSYNC=--vsync

FCITX=$(have fcitx5 && echo fcitx5 || echo fcitx)
GEOCLUE2=$(
  # libexec is used in slackware, lib is in arch
  [[ -x /usr/libexec/geoclue-2.0/demos/agent ]] \
    && echo /usr/libexec/geoclue-2.0/demos/agent \
    || echo /usr/lib/geoclue-2.0/demos/agent
)

run_bg_guarded sxhkd
run_bg_guarded blueman-applet
run_bg_guarded dunst
run_bg_guarded xscreensaver -no-splash
run_bg_guarded udiskie --tray
run_bg_guarded $GEOCLUE2 # required for redshift
run_bg_guarded redshift-gtk
run_bg_guarded joystickwake --loglevel debug
[[ ${IM:-} == "ibus" ]] && run_guarded ibus-daemon -d -r --xim
[[ ${IM:-} == "fcitx" ]] && run_guarded $FCITX -d -r
run_guarded picom -b ${PICOM_VSYNC:-}

# if autorandr-launcher is installed (presumably because udev was not) then daemonize
run_guarded autorandr-launcher --daemonize

# if pipewire in available in the system, enable it
if have pipewire; then
  INIT=$(ps --no-headers -o comm 1)
  if [[ "$INIT" != "systemd" ]]; then
    # on slackware we don't use systemd, so enable logging explicitly
    export PIPEWIRE_LOG=~/.pipewire.log
  fi

  pipewire &
  pipewire-pulse &

  if have wireplumber; then
    log "pipewire session manager: running wireplumber"
    wireplumber &
  elif have pipewire-media-session; then
    log "pipewire session manager: running pipewire-media-session"
    pipewire-media-session &
  else
    log "pipewire session manager: not found"
  fi
fi

if [[ -e "/etc/slackware-version" ]]; then
  if have sun; then
    sun status | grep -q "SUN is running" || sun start
    sun start --tray
  else
    warn_missing sun
  fi
fi

# if NetworkManager is running and nm-applet is installed, run it
pidof NetworkManager >/dev/null && run_bg_guarded nm-applet

# bashism
# a monitor may be connected but not have a resolution
# match the resultion format with grep to ensure we check a monitor that is being used
if have xrandr && [[ 
    "$(
      xrandr | 
      grep " connected" | 
      grep -E '[0-9]{1,4}x([0-9]{1,4})' | 
      head -n 1
    )" =~ [0-9]{1,4}x([0-9]{1,4})\+[0-9]{1,4}\+[0-9]{1,4} && "${BASH_REMATCH[1]}" -gt "1080" 
]]; then
  log "detected a hidpi system, setting Xresources.hidpi"
  run_guarded xrdb -merge "$HOME/.Xresources.hidpi"
fi

if [ -x "$HOME/.screenlayout/default.sh" ]; then
  log "detected custom screenlayout configuration, running it"
  "$HOME/.screenlayout/default.sh"
fi

if [[ -d ~/.wallpaper ]]; then
  run_guarded feh --bg-fill --randomize ~/.wallpaper/*
fi

if have xwinwrap && have xrandr; then
  # supports having different videos per screen, for example, backgroud.DP-4.mkv
  BACKGROUND_VIDEO_STEM=~/.config/background

  while IFS=' ' read -r screen geometry;
  do
    video="$BACKGROUND_VIDEO_STEM.$screen.mkv"
    [[ -e "$video" ]] && 
      xwinwrap -ni -s -b -ov -g $geometry -d -- mpv "$video" --no-audio --loop inf -wid WID --no-stop-screensaver;
  done < <( # requries bash over sh
    xrandr | 
    # normalizes primary screens, which appear in the third column, and filters out invalid dimensions and positions
    sed "s/primary //" |
    grep -e '[0-9]\{4\}x[0-9]\{4\}' | 
    grep ' connected' | 
    cut -f 1,3 -d ' ' | 
    sort -u
  )
fi
